Alipw.ComboBox=Alipw.extend(Alipw.BorderContainer,{baseCls:"alipw-combobox",overCls:"alipw-combobox-over",downCls:"alipw-combobox-down",disabledCls:"alipw-combobox-disabled",expandedCls:"alipw-combobox-expanded",expandedUpCls:"alipw-combobox-expanded-up",expandedDownCls:"alipw-combobox-expanded-down",listCls:"",listAboveCls:"alipw-combobox-list-above",listUnderneathCls:"alipw-combobox-list-underneath",showListShadow:true,listMaxHeight:300,value:null,expanded:false,width:150,height:24,listAutoWidth:false,store:null,displayField:"text",valueField:"value",name:"",applyTo:null,fieldEl:null,constructor:function(){Alipw.ComboBox.superclass.constructor.apply(this,arguments)},commitProperties:function(){Alipw.ComboBox.superclass.commitProperties.apply(this,arguments);if(this.applyTo){this.fieldEl=Alipw.convertEl(this.applyTo);if(this.fieldEl[0]){var a=new Array();this.displayField="text";this.valueField="value";this.fieldEl.find("option").each(function(b,c){var d=$(c).attr("value");if((Alipw.isIE6||Alipw.isIE7)&&c.attributes.value.specified==false){d=c.innerHTML}else{if(!Alipw.isSet(d)){d=c.innerHTML}}a.push({text:c.innerHTML,value:d})});this.store=new Alipw.DataStore({data:a});this.renderTo=this.fieldEl.parent();this.value=this.fieldEl.val();if(this.fieldEl.attr("disabled")||this.fieldEl[0].disabled==true){this.enabled=false}if(Alipw.isIE6){this.fieldEl.css({position:"absolute",top:"-99999999px",left:"-99999999px"})}else{this.fieldEl.hide()}}}},initialize:function(){Alipw.ComboBox.superclass.initialize.apply(this,arguments)},createDom:function(){Alipw.ComboBox.superclass.createDom.apply(this,arguments);this.appendChild(new Alipw.Template(['<div class="{$baseCls}-text"></div>']).set({baseCls:this.baseCls}).compile())},renderComplete:function(){Alipw.ComboBox.superclass.renderComplete.apply(this,arguments);this.addEventListener("click",this.clickHandler_ComboBox,this,true);var c=Alipw.createFuncProxy(this.documentClickHandler_ComboBox,this);var a=Alipw.createFuncProxy(this.windowResizeHandler_ComboBox,this);var b=Alipw.createFuncProxy(this.documentMouseWheelScrollHandler_ComboBox,this);Alipw.getDoc().bind("click",c);Alipw.getWin().bind("resize",a);if(Alipw.isIE||Alipw.isOpera||Alipw.isWebKit){Alipw.getDoc().bind("mousewheel",b)}else{Alipw.getDoc().bind("DOMMouseScroll",b)}this.addEventListener("destroy",function(){Alipw.getDoc().unbind("click",c);Alipw.getWin().unbind("resize",a);if(Alipw.isIE||Alipw.isOpera||Alipw.isWebKit){Alipw.getDoc().unbind("mousewheel",b)}else{Alipw.getDoc().unbind("DOMMouseScroll",b)}this.fieldEl=null},this);if(this.fieldEl&&this.fieldEl[0]){this.el.insertBefore(this.fieldEl)}else{this.fieldEl=jQuery('<input type="hidden" name="'+this.name+'" style="display:none" value="'+(Alipw.isSet(this.value)?this.value:"")+'" />');this.fieldEl.insertAfter(this.el)}this.setValue(this.value);if(!this.enabled){this.setEnabled_ComboBox(false)}},_doLayout:function(){Alipw.ComboBox.superclass._doLayout.apply(this,arguments)},expand:function(){if(!this.enabled||this.expanded){return}this.__isExpanding=true;if(!this.list){this.list=new Alipw.List({floating:true,createFieldEl:false,showShadow:this.showListShadow,subCls:"alipw-combobox-list",cls:this.listCls,maxHeight:this.listMaxHeight,store:this.store,width:this.width,displayField:this.displayField,valueField:this.valueField,value:this.value});this.list.addEventListener("itemclick",this.listItemClickHandler_ComboBox,this);this.list.addEventListener("select",this.listSelectHandler_ComboBox,this);this.list.addEventListener("change",this.listChangeHandler_ComboBox,this);this.list.addEventListener("valueChange",this.listValueChangeHandler_ComboBox,this);this.addEventListener("destroy",function(){if(this.list){this.list.destroy()}},this);if(this.listAutoWidth){this.list._ComboBox_autoWidth=this.list.getContentWidth()}}this.list.setVisible(true);var h=this.getWidth();if(this.listAutoWidth&&h<this.list._ComboBox_autoWidth){this.list.setWidth(this.list._ComboBox_autoWidth)}else{this.list.setWidth(h)}var f=this.list.selectedItems[0];if(f){this.list.getBody().scrollTop(this.list.selectedItems[0].el[0].offsetTop-parseInt((this.list.getHeight()-f.getHeight())/2))}var e=this.getX();var d=this.getY();var a=e;var g=d+this.getHeight();var b=jQuery(window).height();var c=this.list.getHeight();if(b-(g-jQuery(document).scrollTop())<c+10){this.list.el.addClass(this.listAboveCls);this.el.addClass(this.expandedUpCls);this.list.el.removeClass(this.listUnderneathCls);this.el.removeClass(this.expandedDownCls);g=d-c}else{this.list.el.removeClass(this.listAboveCls);this.el.removeClass(this.expandedUpCls);this.list.el.addClass(this.listUnderneathCls);this.el.addClass(this.expandedDownCls)}this.list.setPosition(Math.round(a),Math.round(g));Alipw.ComponentManager.bringToFront(this.list);this.expanded=true;this.el.addClass(this.expandedCls);this.__isExpanding=false},collapse:function(){if(!this.expanded){return}if(this.list){this.list.setVisible(false)}this.expanded=false;this.el.removeClass(this.expandedCls);this.el.removeClass(this.expandedUpCls);this.el.removeClass(this.expandedDownCls)},setText:function(a){this.el.find("."+this.baseCls+"-text").text(a)},setValue:function(b){var a=b!=this.value;this.applyValue_ComboBox(b);if(this.list){this.list.setValue(b)}else{if(a){this.fireEvent("valueChange",{},false);this.fieldEl.triggerHandler("alipw-valueChange")}}},setStore:function(a){this.store=a;this.updateStore()},updateStore:function(){if(!this.store){return}var b=this.store.getData();var a=b[0]?b[0][this.valueField]:"";if(this.fieldEl[0].nodeName=="SELECT"){this.fieldEl.empty();Alipw.each(b,function(c,d){this.fieldEl.append('<option value="'+d[this.valueField]+'">'+d[this.displayField]+"</option>")},this)}this.setValue(a);if(this.list){this.collapse();this.list.destroy();this.list=null}},enable:function(){Alipw.ComboBox.superclass.enable.apply(this,arguments);this.setEnabled_ComboBox(true)},disable:function(){Alipw.ComboBox.superclass.disable.apply(this,arguments);this.setEnabled_ComboBox(false)},setEnabled_ComboBox:function(a){if(a){this.el.removeClass(this.disabledCls);if(this.fieldEl&&this.fieldEl[0]){this.fieldEl[0].disabled=false}}else{this.el.addClass(this.disabledCls);if(this.fieldEl&&this.fieldEl[0]){this.fieldEl[0].disabled=true}}},applyValue_ComboBox:function(b){if(!Alipw.isSet(b)||!(this.store instanceof Alipw.DataStore)){return}this.value=null;this.setText("");this.fieldEl.val("");var a=this.store.getData();Alipw.each(a,function(c,d){if(b==d[this.valueField]){this.setText(d[this.displayField]);this.value=b;this.fieldEl.val(b);return false}},this)},clickHandler_ComboBox:function(a){if(this.expanded){this.collapse()}else{this.expand()}},documentClickHandler_ComboBox:function(a){if(this.destroyed){return}if(Alipw.isInNode(a.target,this.el[0])||(this.list&&Alipw.isInNode(a.target,this.list.el[0]))){return}this.collapse()},windowResizeHandler_ComboBox:function(a){if(this.destroyed){return}if(this.__isExpanding){return}this.collapse()},documentMouseWheelScrollHandler_ComboBox:function(b){if(this.destroyed){return}if(this.list){if(Alipw.isInNode(b.target,this.list.el[0])){b.preventDefault();var a;if(Alipw.isIE||Alipw.isOpera||Alipw.isWebKit){a=-1*b.wheelDelta/40}else{a=b.detail}this.list.scrollY(a*10)}else{this.collapse()}}},listItemClickHandler_ComboBox:function(a){this.collapse()},listSelectHandler_ComboBox:function(a){this.fireEvent("select",{index:a.index,item:a.item},false)},listValueChangeHandler_ComboBox:function(b){var a=b.currentTarget;this.applyValue_ComboBox(a.value);this.fireEvent("valueChange",{},false);this.fieldEl.triggerHandler("alipw-valueChange")},listChangeHandler_ComboBox:function(a){this.fireEvent("change",{},false);this.fieldEl.trigger("change")}});