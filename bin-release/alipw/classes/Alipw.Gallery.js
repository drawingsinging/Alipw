Alipw.Gallery=Alipw.extend(Alipw.BoxComponent,{initIndex:0,width:640,height:480,thumbWidth:80,thumbHeight:60,picMaxWidth:null,picMaxHeight:null,dataProvider:[],dataProxy:null,maxDisplayPage:5,gap:10,thumbBarPosition:"top",prevText:"上一张",nextText:"下一张",showBigNavBtn:true,baseCls:"aliyun-com-gallery",constructor:function(){Alipw.Gallery.superclass.constructor.apply(this,arguments)},initialize:function(){Alipw.Gallery.superclass.initialize.apply(this,arguments);this._pageBegin=0;this._pageEnd=0;if(this.dataProxy&&this.dataProxy.total){this.totalLen=this.dataProxy.total;this._pageEnd=parseInt(this.dataProvider.length/this.dataProxy.limit)-1;this.dataProxy.addEventListener("complete",this.dataLoadHandler,this)}else{if(this.dataProvider){this.totalLen=this.dataProvider.length}}},createDom:function(){Alipw.Gallery.superclass.createDom.apply(this,arguments);var b=['<div class="'+this.baseCls+'-thumbs">','<a href="javascript:void(0)" hidefocus="true" class="'+this.baseCls+'-prevBtn"></a>','<a href="javascript:void(0)" hidefocus="true" class="'+this.baseCls+'-nextBtn"></a>','<div class="'+this.baseCls+'-scrollWrapper">',"<ul></ul>","</div>","</div>"].join("");var a=['<div class="'+this.baseCls+'-pic">','<div class="'+this.baseCls+'-pic-wrap">',"<img />",'<a href="javascript:void(0)" hidefocus="true" title="'+this.prevText+'" class="'+this.baseCls+'-prevBtn-big"></a>','<a href="javascript:void(0)" hidefocus="true" title="'+this.nextText+'" class="'+this.baseCls+'-nextBtn-big"></a>',"</div>","</div>"].join("");if(this.thumbBarPosition=="top"){this.el.append(['<div class="'+this.baseCls+'-wrap">',b,a,"</div>"].join(""))}else{if(this.thumbBarPosition=="bottom"){this.el.append(['<div class="'+this.baseCls+'-wrap">',a,b,"</div>"].join(""))}}},renderComplete:function(){Alipw.Gallery.superclass.renderComplete.apply(this,arguments);this.thumbCon=this.el.find("."+this.baseCls+"-thumbs");var c=this.thumbHeight+this.gap*2+4;this.thumbCon.height(c);var d=this.el.find("."+this.baseCls+"-prevBtn");var a=this.el.find("."+this.baseCls+"-nextBtn");d.bind("click",[this],this.prevBtnClickHandler);a.bind("click",[this],this.nextBtnClickHandler);d.height(this.thumbHeight+4-2);a.height(this.thumbHeight+4-2);var h=this.el.find("."+this.baseCls+"-scrollWrapper>ul");this.scrollWrapper=h.parent();this.thumbItems=new Array();var j=new Array();var f;for(var e=0,g=this.dataProvider.length;e<g;e++){j[e]=this.createThumbItem(e);j[e].setSrc(this.dataProvider[e][1]);this.thumbItems.push(j[e]);h.append(j[e])}var l=this.width-this.gap*2;if(this.picMaxWidth&&l>this.picMaxWidth){l=this.picMaxWidth}var k=this.height-c-this.gap*2;if(this.picMaxHeight&&k>this.picMaxHeight){k=this.picMaxHeight}this.bigPicCon=this.el.find("."+this.baseCls+"-pic");this.bigImg=this.bigPicCon.find("img");this.bigImg.css("opacity","0");this.bigImg.bind("load",[l,k],this.adjustPicSize);this.bigImg.bind("load","bigPic",jQuery.proxy(this.picCompleteHandler,this));this.bigPicCon.css({width:l+this.gap*2+"px",height:k+this.gap*2+"px"});this.bigPicConWrap=this.bigPicCon.find("."+this.baseCls+"-pic-wrap");this.bigPicConWrap.css({width:l+"px",height:k+"px",padding:this.gap+"px"});var b=this.el.find("."+this.baseCls+"-prevBtn-big");var m=this.el.find("."+this.baseCls+"-nextBtn-big");if(!this.showBigNavBtn){b.hide();m.hide()}b.bind("click",[this],this.prevBtnClickHandler);m.bind("click",[this],this.nextBtnClickHandler);if(this.dataProxy&&(!this.dataProvider||this.dataProvider.length<1)){this.dataProvider=[];this.loadItems(0)}else{this.gotoPic(this.initIndex)}},gotoPic:function(d){var f=this;if(this.currentIndex==d){}if(d=="next"){if(this.currentIndex<this.thumbItems.length-1){d=this.currentIndex+1}else{return}}else{if(d=="prev"){if(this.currentIndex>0){d=this.currentIndex-1}else{return}}}if(!this.dataProvider[d]){return}var e=this.currentIndex;this.currentIndex=d;if(this.thumbItems[e]){this.thumbItems[e].removeClass("on");this.thumbItems[e].stop();this.thumbItems[e].animate({opacity:0.4},300)}this.thumbItems[d].addClass("on");this.thumbItems[d].stop();this.thumbItems[d].animate({opacity:1},100);this.scrollWrapper.stop();var b=(this.thumbWidth+4+this.gap)*d-(this.thumbCon.width()-(this.thumbWidth+this.gap+4))/2;var c=(this.thumbWidth+4+this.gap)*this.totalLen-this.thumbCon.width();var a=false;if(c<0){b=c/2;a=true}else{if(b<0){b=0}else{if(b>c){b=c}}}if(!a){if((this.thumbWidth+4+this.gap)*this.thumbItems.length-b<this.thumbCon.width()){this.loadItems(this._pageEnd+1);this.clearThumbItems("header")}else{if(this._leftSpacer-b>0){this.loadItems(this._pageBegin-1);this.clearThumbItems("footer")}}}if(b>=0){this.scrollWrapper.animate({scrollLeft:b},600,"easeOutExpo")}else{this.scrollWrapper.attr("scrollLeft",0);this.scrollWrapper.find("ul").css("margin-left",(-b)+"px")}this.bigPicConWrap.removeClass("load-complete");if(this.isLoadingBigPic){this.bigImg.stop();this.bigImg.css("opacity","0");this.bigImg.css("filter","alpha(opacity=0)");this.bigImg.attr("src","");this.bigImg.attr("src",f.dataProvider[d][0])}else{this.isLoadingBigPic=true;this.bigImg.stop();this.bigImg.animate({opacity:0},300,function(){f.bigImg.attr("src","");f.bigImg.attr("src",f.dataProvider[d][0])})}},itemClickHandler:function(b){var c=b.data[0];var a=b.data[1];c.gotoPic(a)},adjustPicSize:function(a){Alipw.adjustImgSize(a.currentTarget,a.data[0],a.data[1])},picCompleteHandler:function(b){var a=$(b.currentTarget);if(b.data=="bigPic"){this.isLoadingBigPic=false}a.animate({opacity:1},300,function(){a.css("filter","")});a.parent().addClass("load-complete")},itemMouseOverHandler:function(b){var c=b.data[0];var a=b.data[1];if(a==c.currentIndex){return}jQuery(b.currentTarget).stop();jQuery(b.currentTarget).animate({opacity:1},100)},itemMouseOutHandler:function(b){var c=b.data[0];var a=b.data[1];if(a==c.currentIndex){return}jQuery(b.currentTarget).stop();jQuery(b.currentTarget).animate({opacity:0.4},300)},prevBtnClickHandler:function(a){var b=a.data[0];b.gotoPic("prev")},nextBtnClickHandler:function(a){var b=a.data[0];b.gotoPic("next")},dataLoadHandler:function(e){var count;var proxy=e.currentTarget;eval(e.content);if(count){proxy.total=count;this.totalLen=count}var len=this.dataProvider.length;this.dataProvider=this.dataProvider.concat(data);if(this.dataProvider.length>this.dataProxy.total){var num=this.dataProvider.length-this.dataProxy.total;var start=this.dataProvider.length-num;this.dataProvider.splice(start,num)}var from=len;var to=from+data.length;if(to>this.totalLen){to=this.totalLen}var ul=this.el.find("."+this.baseCls+"-scrollWrapper>ul");for(var i=from;i<to;i++){if(!this.thumbItems[i]){this.thumbItems[i]=this.createThumbItem(i);ul.append(this.thumbItems[i])}this.thumbItems[i].setSrc(this.dataProvider[i][1])}if(!Alipw.isSet(this.currentIndex)){this.gotoPic(this.initIndex)}},createThumbItem:function(b){var c=b;var d=jQuery('<li style="margin-right:'+this.gap+"px; width:"+this.thumbWidth+"px; height:"+this.thumbHeight+'px;"><div class="'+this.baseCls+'-highlightArrow"></div></li>');var a=jQuery('<img style="width:'+this.thumbWidth+"px; height:"+this.thumbHeight+'px" />');a.css("opacity","0");a.css("filter","alpha(opacity=0)");a.bind("load",[this.thumbWidth,this.thumbHeight],this.adjustPicSize);a.bind("load",jQuery.proxy(this.picCompleteHandler,this));d.bind("click",[this,c],this.itemClickHandler);d.bind("mouseover",[this,c],this.itemMouseOverHandler);d.bind("mouseout",[this,c],this.itemMouseOutHandler);d.append(a);d.setSrc=function(e){jQuery(this).find("img").attr("src",e)};return d},loadItems:function(c){var a=this.dataProxy.limit;var f=this.el.find("."+this.baseCls+"-scrollWrapper>ul");if(c<this._pageBegin){for(var e=c*a+a-1,h=c*a;e>=h;e--){if(this.thumbItems[e]&&this.thumbItems[e]._removed){f.prepend(this.thumbItems[e]);this.thumbItems[e]._removed=false}}this._leftSpacer-=this.dataProxy.limit*(this.thumbWidth+4+this.gap);f.css("margin-left",this._leftSpacer+"px");this._pageBegin-=1}else{var g=a;var b=this.totalLen-a*(this._pageEnd+1);if(b<a){g=b}var d;for(var e=0;e<g;e++){d=this.createThumbItem(a*c+e);this.thumbItems.push(d);f.append(d)}this._pageEnd+=1;if(this.dataProxy){this.dataProxy.load(c)}}},clearThumbItems:function(h){if(!this._leftSpacer){this._leftSpacer=0}var d=this.el.find("."+this.baseCls+"-scrollWrapper>ul");var a=this.dataProxy.limit;var e=this.dataProxy.total;if(this._pageEnd-this._pageBegin+1>this.maxDisplayPage){if(h=="header"){for(var c=this._pageBegin*a,g=this._pageBegin*a+a;c<g;c++){if(this.thumbItems[c]&&!this.thumbItems[c]._removed){this.thumbItems[c]._removed=true;this.thumbItems[c].parent()[0].removeChild(this.thumbItems[c][0])}}this._leftSpacer+=this.dataProxy.limit*(this.thumbWidth+4+this.gap);d.css("margin-left",this._leftSpacer+"px");this._pageBegin+=1}else{var g;if((this._pageEnd+1)*a>e){g=e}else{g=(this._pageEnd+1)*a}for(var c=this._pageEnd*a;c<g;c++){if(this.thumbItems[c]&&!this.thumbItems[c]._removed){this.thumbItems[c]._removed=true;this.thumbItems[c].remove()}}var b=this.thumbItems.length-this._pageEnd*a;var f=this._pageEnd*a;this.thumbItems.splice(f,b);this.dataProvider.splice(f,b);this._pageEnd-=1}}}});